#!/bin/bash

if [ "$1" == "" -o "$2" == "" ]
then
    echo "processes products with MapReduce"
    echo "usage  : $0 <source-url> <format> <operator>"
    echo "example: $0 hdfs://cvmaster00:9000/data/experiments/lineinterleaved/MERIS-RR-2010-08 lineinterleaved"
    echo "creates dir hdfs://cvmaster00:9000/output/lineinterleaved/MERIS-RR-2010-08/*"
    exit 1
fi

commandline="$0 $*"
command=$0
sourceUrl=$1
format=$2
operator=$3
sourceName=`basename ${sourceUrl}`
targetUrl=hdfs://cvmaster00:9000/output/${format}/${sourceName}
now=`date '+%Y-%m-%dT%H:%M:%S'`
shift 3
logfile=processing-${sourceName}-${format}-${operator}-${now}

echo ${commandline}

hadoop --config ~/hpc/conf fs -rmr ${targetUrl} > /dev/null 2>&1

time hadoop --config ~/hpc/conf jar /home/boe/modules/calvalus/calvalus-experiments/target/calvalus-experiments-0.1-SNAPSHOT-job.jar com.bc.calvalus.experiments.processing.ProcessingTool ${sourceUrl} ${targetUrl} ${format} ${operator} $@ > ${logfile}.tmp 2>&1

job_number=`cat ${logfile}.tmp | awk "/ Running job: / { print substr(\\$7,5) }"`

echo ${job_number}

`dirname ${command}`/retrieveprocessinglogs ${job_number}
#`dirname ${command}`/analyseprocessinglogs ${job_number}
#echo ${commandline} > ${logfile}
#cat ${job_number}.list >> ${logfile}
#rm ${job_number}.list

#echo ${logfile}
